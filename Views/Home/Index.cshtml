@model IdentityServerHost.Services.DashboardStats
@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var overviewData = new[] {
        new { category = "Người dùng", value = Model.UsersCount, color = "#7239EA" },
        new { category = "Vai trò", value = Model.RolesCount, color = "#50CD89" },
        new { category = "Clients", value = Model.ClientsCount, color = "#009EF7" },
        new { category = "API Resources", value = Model.ApiResourcesCount, color = "#FFC700" },
        new { category = "API Scopes", value = Model.ApiScopesCount, color = "#F1416C" },
        new { category = "Identity Resources", value = Model.IdentityResourcesCount, color = "#00A3FF" }
    };
    var grantTypeData = Model.ClientsByGrantType.Any()
        ? Model.ClientsByGrantType.Select(x => new { grantType = x.GrantType.Length > 25 ? x.GrantType.Substring(0, 22) + "..." : x.GrantType, count = x.Count }).ToList()
        : new[] { new { grantType = "Chưa có dữ liệu", count = 1 } }.ToList();
    var resourceData = Model.ResourcesOverview.Select(x => new { category = x.Category, value = x.Count }).ToList();
}

<div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
    <div id="kt_app_toolbar_container" class="app-container container-fluid d-flex flex-stack">
        <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
            <h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0">Dashboard</h1>
            <ul class="breadcrumb breadcrumb-separatorless fw-semibold fs-7 my-0 pt-1">
                <li class="breadcrumb-item text-muted">
                    <a asp-controller="Home" asp-action="Index" class="text-muted text-hover-primary">Trang chủ</a>
                </li>
                <li class="breadcrumb-item"><span class="bullet bg-gray-500 w-5px h-2px"></span></li>
                <li class="breadcrumb-item text-muted">Thống kê</li>
            </ul>
        </div>
    </div>
</div>

<div id="kt_app_content" class="app-content flex-column-fluid">
    <div id="kt_app_content_container" class="app-container container-fluid">
        <div class="row g-5 gx-xl-10 mb-5 mb-xl-10">
            <div class="col-xl-3 col-md-6">
                <a asp-controller="Users" asp-action="Index" class="card card-flush h-100 mb-5 mb-xl-10 hover-elevate-up text-decoration-none">
                    <div class="card-header pt-5">
                        <div class="card-title d-flex align-items-center">
                            <i class="ki-duotone ki-people fs-2hx text-primary me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                                <span class="path5"></span>
                            </i>
                            <span class="text-gray-500 fw-semibold fs-6">Người dùng</span>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <div class="d-flex flex-column">
                            <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">@Model.UsersCount</span>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-xl-3 col-md-6">
                <a asp-controller="Roles" asp-action="Index" class="card card-flush h-100 mb-5 mb-xl-10 hover-elevate-up text-decoration-none">
                    <div class="card-header pt-5">
                        <div class="card-title d-flex align-items-center">
                            <i class="ki-duotone ki-shield-tick fs-2hx text-success me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                            <span class="text-gray-500 fw-semibold fs-6">Vai trò</span>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <div class="d-flex flex-column">
                            <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">@Model.RolesCount</span>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-xl-3 col-md-6">
                <a asp-controller="Clients" asp-action="Index" class="card card-flush h-100 mb-5 mb-xl-10 hover-elevate-up text-decoration-none">
                    <div class="card-header pt-5">
                        <div class="card-title d-flex align-items-center">
                            <i class="ki-duotone ki-element-11 fs-2hx text-info me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                            <span class="text-gray-500 fw-semibold fs-6">Clients</span>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <div class="d-flex flex-column">
                            <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">@Model.ClientsCount</span>
                            <span class="text-success fs-7">@Model.ActiveClientsCount đang bật</span>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card card-flush h-100 mb-5 mb-xl-10">
                    <div class="card-header pt-5">
                        <div class="card-title d-flex align-items-center">
                            <i class="ki-duotone ki-key fs-2hx text-warning me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                            <span class="text-gray-500 fw-semibold fs-6">Tokens đang lưu</span>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <div class="d-flex flex-column">
                            <span class="fs-2hx fw-bold text-gray-900 me-2 lh-1 ls-n2">@Model.PersistedGrantsCount</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-5 gx-xl-10 mb-5">
            <div class="col-12">
                <a asp-controller="Alerts" asp-action="Index" class="card card-flush hover-elevate-up text-decoration-none">
                    <div class="card-header pt-5">
                        <div class="card-title d-flex align-items-center">
                            <i class="ki-duotone ki-notification-bing fs-2hx text-danger me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                                <span class="path4"></span>
                            </i>
                            <span class="fs-4 fw-bold text-gray-900 me-2">Giám sát & Cảnh báo</span>
                        </div>
                        <div class="card-toolbar">
                            <span class="badge badge-light-warning">Xem chi tiết</span>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <span class="text-gray-500 fw-semibold fs-7">Sự kiện đăng nhập thất bại, lỗi hệ thống</span>
                    </div>
                </a>
            </div>
        </div>
        <div class="row g-5 gx-xl-10">
            <div class="col-xl-8">
                <div class="card card-flush h-md-100">
                    <div class="card-header pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold text-gray-900">Tổng quan hệ thống</span>
                            <span class="text-muted mt-1 fw-semibold fs-7">Số lượng theo từng loại</span>
                        </h3>
                    </div>
                    <div class="card-body pt-5">
                        <div id="chartOverview" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>
            </div>
            <div class="col-xl-4">
                <div class="card card-flush h-md-100">
                    <div class="card-header pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold text-gray-900">Phân bố Resources</span>
                            <span class="text-muted mt-1 fw-semibold fs-7">API Resources, Scopes, Identity</span>
                        </h3>
                    </div>
                    <div class="card-body pt-5">
                        <div id="chartResources" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-5 gx-xl-10 mt-5">
            <div class="col-xl-6">
                <div class="card card-flush h-md-100">
                    <div class="card-header pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold text-gray-900">Clients theo Grant Type</span>
                            <span class="text-muted mt-1 fw-semibold fs-7">Số client sử dụng từng loại grant</span>
                        </h3>
                    </div>
                    <div class="card-body pt-5">
                        <div id="chartGrantTypes" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>
            </div>
            <div class="col-xl-6">
                <div class="card card-flush h-md-100">
                    <div class="card-header pt-5">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="card-label fw-bold text-gray-900">Biểu đồ cột - Tổng quan</span>
                            <span class="text-muted mt-1 fw-semibold fs-7">So sánh số lượng</span>
                        </h3>
                    </div>
                    <div class="card-body pt-5">
                        <div id="chartColumn" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
<script>
document.addEventListener("DOMContentLoaded", function() {
    if (typeof am5 === 'undefined') return;

    am5.ready(function() {
        var root = am5.Root.new("chartOverview");
        root.setThemes([am5themes_Animated.new(root)]);
        var chart = root.container.children.push(am5xy.XYChart.new(root, { layout: root.verticalLayout }));
        var xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
            categoryField: "category",
            renderer: am5xy.AxisRendererX.new(root, { minGridDistance: 30 })
        }));
        xAxis.data.setAll(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(overviewData)));
        var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
            renderer: am5xy.AxisRendererY.new(root, {})
        }));
        var series = chart.series.push(am5xy.ColumnSeries.new(root, {
            name: "Số lượng",
            xAxis: xAxis,
            yAxis: yAxis,
            valueYField: "value",
            categoryXField: "category"
        }));
        series.columns.template.setAll({
            tooltipText: "{categoryX}: {valueY}",
            cornerRadiusBL: 5,
            cornerRadiusBR: 5
        });
        series.columns.template.adapters.add("fill", function(fill, target) {
            return target.dataItem?.dataContext?.color || "#009EF7";
        });
        series.data.setAll(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(overviewData)));
        series.bullets.push(function() {
            return am5.Bullet.new(root, {
                locationY: 1,
                sprite: am5.Label.new(root, {
                    text: "{valueY}",
                    fill: root.interfaceColors.get("background"),
                    centerY: am5.p50,
                    centerX: am5.p50,
                    populateText: true
                })
            });
        });
        chart.set("cursor", am5xy.XYCursor.new(root, {}));
        chart.set("scrollbarX", am5.Scrollbar.new(root, { orientation: "horizontal" }));
    });

    am5.ready(function() {
        var root = am5.Root.new("chartResources");
        root.setThemes([am5themes_Animated.new(root)]);
        var chart = root.container.children.push(am5percent.PieChart.new(root, {}));
        var series = chart.series.push(am5percent.PieSeries.new(root, {
            valueField: "value",
            categoryField: "category"
        }));
        series.data.setAll(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(resourceData)));
        series.labels.template.set("visible", false);
        series.ticks.template.set("visible", false);
        var legend = chart.children.push(am5.Legend.new(root, {
            centerX: am5.p50,
            x: am5.p50,
            layout: root.horizontalLayout
        }));
        legend.data.setAll(series.dataItems);
    });

    am5.ready(function() {
        var root = am5.Root.new("chartGrantTypes");
        root.setThemes([am5themes_Animated.new(root)]);
        var chart = root.container.children.push(am5percent.PieChart.new(root, {}));
        var series = chart.series.push(am5percent.PieSeries.new(root, {
            valueField: "count",
            categoryField: "grantType"
        }));
        series.data.setAll(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(grantTypeData)));
        series.labels.template.set("visible", false);
        series.ticks.template.set("visible", false);
        var legend = chart.children.push(am5.Legend.new(root, {
            centerX: am5.p50,
            x: am5.p50,
            layout: root.horizontalLayout
        }));
        legend.data.setAll(series.dataItems);
    });

    am5.ready(function() {
        var root = am5.Root.new("chartColumn");
        root.setThemes([am5themes_Animated.new(root)]);
        var chart = root.container.children.push(am5xy.XYChart.new(root, { layout: root.verticalLayout }));
        var xAxis = chart.xAxes.push(am5xy.CategoryAxis.new(root, {
            categoryField: "category",
            renderer: am5xy.AxisRendererX.new(root, { minGridDistance: 30 })
        }));
        xAxis.data.setAll(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(overviewData)));
        var yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
            renderer: am5xy.AxisRendererY.new(root, {})
        }));
        var series = chart.series.push(am5xy.ColumnSeries.new(root, {
            name: "Số lượng",
            xAxis: xAxis,
            yAxis: yAxis,
            valueYField: "value",
            categoryXField: "category"
        }));
        series.columns.template.setAll({
            tooltipText: "{categoryX}: {valueY}",
            cornerRadiusBL: 5,
            cornerRadiusBR: 5
        });
        series.columns.template.adapters.add("fill", function(fill, target) {
            return target.dataItem?.dataContext?.color || "#009EF7";
        });
        series.data.setAll(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(overviewData)));
        chart.set("cursor", am5xy.XYCursor.new(root, {}));
    });
});
</script>
}
